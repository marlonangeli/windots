[CmdletBinding()]
param()

$ErrorActionPreference = "Stop"

$homeDir = [Environment]::GetFolderPath("UserProfile")
$sources = @(
    (Join-Path $homeDir ".config\windows-terminal\settings.json"),
    (Join-Path $homeDir "home\.config\windows-terminal\settings.json")
)
$source = $sources | Where-Object { Test-Path $_ } | Select-Object -First 1
$packagesRoot = Join-Path $homeDir "AppData\Local\Packages"

if (-not $source) {
    Write-Host "[wt-sync] source not found. Checked: $($sources -join ', ')" -ForegroundColor Yellow
    exit 0
}

if (-not (Test-Path $packagesRoot)) {
    Write-Host "[wt-sync] packages folder not found: $packagesRoot" -ForegroundColor Yellow
    exit 0
}

$stableDir = Join-Path $packagesRoot "Microsoft.WindowsTerminal_8wekyb3d8bbwe\LocalState"
$targetDir = $stableDir

if (-not (Test-Path $targetDir)) {
    $fallback = Get-ChildItem -Path $packagesRoot -Directory -Filter "Microsoft.WindowsTerminal*" -ErrorAction SilentlyContinue |
        Where-Object { Test-Path (Join-Path $_.FullName "LocalState") } |
        Sort-Object Name |
        Select-Object -First 1

    if ($fallback) {
        $targetDir = Join-Path $fallback.FullName "LocalState"
    }
}

if (-not (Test-Path $targetDir)) {
    Write-Host "[wt-sync] destination not found (no Windows Terminal package folder)." -ForegroundColor Yellow
    exit 0
}

$target = Join-Path $targetDir "settings.json"
if (-not (Test-Path $targetDir)) {
    New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
}

if (Test-Path $target) {
    try {
        $item = Get-Item $target -ErrorAction Stop
        $item.IsReadOnly = $false
        attrib -R $target 2>$null | Out-Null
    }
    catch {
        Write-Warning "[wt-sync] unable to clear readonly attribute: $target"
    }
}

$sourceHash = (Get-FileHash -Path $source -Algorithm SHA256).Hash
$targetHash = if (Test-Path $target) { (Get-FileHash -Path $target -Algorithm SHA256).Hash } else { "" }

if ($sourceHash -eq $targetHash) {
    Write-Host "[wt-sync] unchanged: $target" -ForegroundColor DarkGray
    exit 0
}

Copy-Item -Path $source -Destination $target -Force
try {
    $written = Get-Item $target -ErrorAction Stop
    $written.IsReadOnly = $false
    attrib -R $target 2>$null | Out-Null
}
catch {
    Write-Warning "[wt-sync] file copied but failed to normalize writable attribute: $target"
}
Write-Host "[wt-sync] synced: $target (from $source)" -ForegroundColor Green

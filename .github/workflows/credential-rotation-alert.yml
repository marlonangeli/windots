name: credential-rotation-alert

on:
  schedule:
    - cron: "0 13 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - name: Open rotation reminder issue near expiry
        uses: actions/github-script@v7
        with:
          script: |
            const expiryDate = "2027-02-26";
            const alertWindowDays = 60;
            const issueTitle = `[Security] Rotate Cloudflare + Bitwarden credentials before ${expiryDate}`;

            const now = new Date();
            const expiry = new Date(`${expiryDate}T00:00:00Z`);
            const msPerDay = 1000 * 60 * 60 * 24;
            const daysUntilExpiry = Math.ceil((expiry - now) / msPerDay);

            core.info(`Days until credential expiry: ${daysUntilExpiry}`);

            if (daysUntilExpiry > alertWindowDays) {
              core.info(`Outside ${alertWindowDays}-day alert window. No issue created.`);
              return;
            }

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });

            const alreadyOpen = existing.find((issue) => issue.title === issueTitle);
            if (alreadyOpen) {
              core.info(`Reminder issue already open: #${alreadyOpen.number}`);
              return;
            }

            const body = [
              "Credential rotation reminder for Cloudflare IaC automation.",
              "",
              `- Expiry date: ${expiryDate}`,
              `- Days remaining: ${daysUntilExpiry}`,
              "",
              "Rotate these credentials:",
              "- Cloudflare API token used by Terraform",
              "- Bitwarden Secrets Manager machine access token (`BWS_ACCESS_TOKEN`)",
              "",
              "After rotation:",
              "1. Update secrets in Bitwarden Secrets Manager",
              "2. Update GitHub environment secret if `BWS_ACCESS_TOKEN` changed",
              "3. Run `infra-cloudflare` workflow via `workflow_dispatch` to verify access"
            ].join("\n");

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body
            });

            core.info("Created credential rotation reminder issue.");
